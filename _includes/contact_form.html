{% comment %}

include:
- common_applications: array of strings (translation keys)

{% endcomment %}
<!--
  This is some slightly modified code provided by the contact center to interact
  with their support ticket intake system
-->
<script language="javascript" type="text/javascript">
  let topicID = '00NU0000004z903';
  let mappedValues = {
    'Signing In;New Account': { topic: 'Create Account', sub: 'New Account' },
  };

  let TopicEntry = function (key, label, subtopics) {
    this.key = key;
    this.label = label || key;
    this.subtopics = subtopics || [];
  };

  let topicMap = [
    new TopicEntry(
      'Create Account',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.creating_account }}",
      [
        new TopicEntry(
          'Email delivery issue',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.email_delivery_issue }}",
        ),
        new TopicEntry(
          'Invalid email',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.invalid_email }}",
        ),
        new TopicEntry(
          'Password issue',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.change_password }}",
        ),
        new TopicEntry(
          'No phone',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.no_phone }}",
        ),
        new TopicEntry(
          'New account',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.new_account }}",
        ),
        new TopicEntry(
          'Authentication app setup',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.authentication_app_setup }}",
        ),
        new TopicEntry(
          'Invalid Personal key',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.personal_key }}",
        ),
        new TopicEntry(
          'Site navigation',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.site_navigation }}",
        ),
        new TopicEntry(
          'Login.gov account for a family member',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.add_family_member }}",
        ),
        new TopicEntry(
          'Bug',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.blank_screen }}",
        ),
        new TopicEntry(
          'Other',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.other }}",
        ),
      ],
    ),
    new TopicEntry(
      'Signing In',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.signing_in }}",
      [
        new TopicEntry(
          'Forgot password',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.forgot_password }}",
        ),
        new TopicEntry(
          'Invalid personal key',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.personal_key }}",
        ),
        new TopicEntry(
          'Locked out',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.locked_out }}",
        ),
        new TopicEntry(
          'Remember device issue',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.remember_device_issue }}",
        ),
        new TopicEntry(
          'Recover account',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.recover_account }}",
        ),
        new TopicEntry(
          'Bug',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.blank_screen }}",
        ),
        new TopicEntry(
          'Site navigation',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.site_navigation }}",
        ),
        new TopicEntry(
          'New Account',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.new_account }}",
        ),
        new TopicEntry(
          'Backup codes',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.backup_codes }}",
        ),
        new TopicEntry(
          'Other',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.other }}",
        ),
      ],
    ),
    new TopicEntry(
      'MFA (Multi Factor Authentication)',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.security_codes }}",
      [
        new TopicEntry(
          'International number',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.international_number }}",
        ),
        new TopicEntry(
          'No OTP received',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.security_code }}",
        ),
        new TopicEntry(
          'Invalid OTP',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.invalid_otp }}",
        ),
        new TopicEntry(
          'Unwanted OTP sent',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.unwanted_otp }}",
        ),
        new TopicEntry(
          'Multiple OTPs sent',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.multiple_otps }}",
        ),
        new TopicEntry(
          'Authentication app',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.authentication_app }}",
        ),
        new TopicEntry(
          'PIV/CAC',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.piv_cac }}",
        ),
        new TopicEntry(
          'Security Key',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.security_key }}",
        ),
        new TopicEntry(
          'New Device Notification',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.device_notification }}",
        ),
        new TopicEntry(
          'Personal Key Notification',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.personal_key_notification }}",
        ),
        new TopicEntry(
          'Other',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.other }}",
        ),
      ],
    ),
    new TopicEntry(
      'Changing Settings',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.changing_settings }}",
      [
        new TopicEntry(
          'Change password',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.change_password }}",
        ),
        new TopicEntry(
          'Change email',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.change_email }}",
        ),
        new TopicEntry(
          'Change phone number',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.change_phone_number }}",
        ),
        new TopicEntry(
          'Delete account',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.delete_account }}",
        ),
        new TopicEntry(
          'Authentication app',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.authentication_app }}",
        ),
        new TopicEntry(
          'New personal key',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.new_personal_key }}",
        ),
        new TopicEntry(
          'New backup codes',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.new_backup_codes }}",
        ),
        new TopicEntry(
          'Other',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.other }}",
        ),
      ],
    ),
    new TopicEntry(
      'Verifying your identity',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.verifying_identity }}",
      [
        new TopicEntry(
          'State-issued ID error',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.state_issued_id_error }}",
        ),
        new TopicEntry(
          'Failure trying to verify my identity',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.verify_identity_error }}",
        ),
        new TopicEntry(
          'Failure after entering phone number',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.phone_number_failure }}",
        ),
        new TopicEntry(
          "Didn't receive letter in mail",
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.letter_in_mail }}",
        ),
        new TopicEntry(
          'Account locked for 24 hours',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.account_locked }}",
        ),
        new TopicEntry(
          'Other',
          "{{ site.data.[page.lang].settings.contact_page.support_request_form.subtopics.other }}",
        ),
      ],
    ),
    new TopicEntry(
      'login.gov System',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.feedback }}",
    ),
    new TopicEntry(
      'Other',
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.topics.other }}",
    ),
  ];

  function remapvalues(frm) {
    // Get the current values for topic and subtopic
    let topic = document.getElementById('00NU0000004z903');
    let sub = document.getElementById('sub-topic');

    let topicValue = topic.value;
    let subValue = sub.value;

    let key = topicValue + ';' + subValue;

    // Do we have a mapping?
    if (mappedValues[key]) {
      sub.value = mappedValues[key].sub;
      topic.value = mappedValues[key].topic;
    }

    return true;
  }

  function populatetopics() {
    let field = document.getElementById(topicID);
    field.options.length = 0;
    field.options[0] = new Option(
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.form_helpers.select_topic }}",
      '',
      false,
      true,
    );

    for (let topic in topicMap) {
      field.options[field.options.length] = new Option(topicMap[topic].label, topicMap[topic].key);
    }
    field.options[0].hidden = true;

    let sub = document.getElementById('sub-topic');
    sub.options[0] = new Option(
      "{{ site.data.[page.lang].settings.contact_page.support_request_form.form_helpers.select_issue }}",
      null,
      false,
      true,
    );
    sub.options[0].hidden = true;
  }

  function dynamicdropdown(listindex) {
    console.log(listindex);
    let sub = document.getElementById('sub-topic');

    let oldvalue = sub.value;
    let options = [];

    let selectedIndex = 0;

    for (let i = 0; i < topicMap.length; i++) {
      console.log(topicMap[i].key);
      if (topicMap[i].key === listindex) {
        console.log(topicMap[i]);
        options.push(
          new Option(
            "{{ site.data.[page.lang].settings.contact_page.support_request_form.form_helpers.select_issue }}",
            '',
            false,
            true,
          ),
        );
        for (let j = 0; j < topicMap[i].subtopics.length; j++) {
          let subtopic = topicMap[i].subtopics[j];
          options.push(new Option(subtopic.label, subtopic.key));
          if (subtopic.key === oldvalue) {
            selectedIndex = j + 1;
          }
        }
        options[0].hidden = true;
      }
    }

    sub.options.length = 0;
    for (let i = 0; i < options.length; i++) {
      sub.options[sub.options.length] = options[i];
    }

    // sub.options = options;
    sub.selectedIndex = selectedIndex;

    return true;
  }

  window.onload = populatetopics;

  function doNotAnswer() {
    // this will hide the display of the honeypot Field
    // more information found here. https://help.salesforce.com/articleView?id=pardot_forms_add_honeypot.htm 
    const noAnswer = document.querySelector('#contact-us-form #information');
    if (noAnswer) {
      noAnswer.removeAttribute('required');
      noAnswer.tabIndex = -1;
      noAnswer.parentElement.setAttribute('aria-hidden', 'true');
      noAnswer.parentElement.style.position = 'absolute';
      noAnswer.parentElement.style.left = '-7000px';
    }
  }
  document.addEventListener('DOMContentLoaded', doNotAnswer);
</script>

<form
  id="contact-us-form"
  action="{{ site.contact_form_action }}"
  method="POST"
  onSubmit="return remapvalues(this); return true;"
  class="usa-form"
>
  <input type="hidden" name="retURL" value="https://login.gov{{ '/' | locale_url }}" />
  <input type="hidden" name="orgid" value="{{ site.contact_form_orgid }}" />
  <input type="hidden" name="status" id="status" value="New" />
  <input type="hidden" id="external" name="external" value="1" />
  <input type="hidden" name="recordType" id="recordType" value="012t00000004JFu" />
  {% if site.contact_form_captcha_enabled != true %}
  <input type="hidden" name="debug" value="1" />
  {% endif %}

  <!-- START: Topic -->
  <label class="usa-label" for="00NU0000004z903"
    >{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.topic }}</label
  >
  <select
    id="00NU0000004z903"
    name="00NU0000004z903"
    required
    onchange="dynamicdropdown(this.options[this.selectedIndex].value);"
    class="usa-select"
  ></select>
  <!-- END: Topic -->

  <!-- START: Subtopic -->
  <label class="usa-label text-normal" for="sub-topic">
    <span class="text-bold"
      >{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.subtopic }}</span
    >
    <span class="usa-hint"
      >({{ site.data.[page.lang].settings.contact_page.support_request_form.labels.optional
      }})</span
    >
  </label>
  <select id="sub-topic" name="00NU0000004z905" class="usa-select"></select>
  <!-- END: Subtopic -->

  <!-- START: Agency Application -->
  <label class="usa-label" for="00Nt0000000OYA2">
    {{ site.data.[page.lang].settings.contact_page.support_request_form.labels.agency_application }}
  </label>
  <select id="00Nt0000000OYA2" name="00Nt0000000OYA2" required class="usa-select">
    <option value="" selected hidden>
      {{ site.data.[page.lang].settings.contact_page.support_request_form.form_helpers.select_agency
      }}
    </option>
    <optgroup
      label="{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.agency_application_common }}"
    >
      {% for common_application in include.common_applications %}
        <option value="{{ common_application }}">
          {{ site.data[page.lang].settings.contact_page.support_request_form.agencies[common_application] }}
        </option>
      {% endfor %}
    </optgroup>
    <optgroup
      label="{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.agency_application_all }}"
    >
      {% assign all_applications_sorted = site.data[page.lang].settings.contact_page.support_request_form.agencies | sort_by_values %}
      {% for application in all_applications_sorted %}
        <option value="{{ application.key }}">
          {{ application.value }}
        </option>
      {% endfor %}
    </optgroup>
    <optgroup
      label="{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.agency_application_other }}"
    >
      <option value="Other">
        {{ site.data.[page.lang].settings.contact_page.support_request_form.other }}
      </option>
    </optgroup>
  </select>
  <!-- END: Agency Application -->

  <!-- START: Email -->
  <label class="usa-label" for="email"
    >{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.email }}</label
  >
  <input
    id="email"
    maxlength="80"
    name="email"
    type="text"
    placeholder="example@example.com"
    pattern="^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)+$"
    required
    class="usa-input"
  />
  <!-- END: Email -->

  <!-- START: Description -->
  <label class="usa-label" for="description"
    >{{ site.data.[page.lang].settings.contact_page.support_request_form.labels.description
    }}</label
  >
  <div class="usa-hint">
    {{ site.data[page.lang].settings.contact_page.support_request_form.labels.pii_warning |
    markdownify | remove: '
    <p>' | remove: '</p>
    ' }}
  </div>

  <div
    id="pii-warning-message"
    class="usa-error-message margin-bottom-4"
    role="alert"
    data-error="{{ site.data.[page.lang].settings.contact_page.support_request_form.errors.pii_found }}"
  ></div>

  <textarea
    id="description"
    name="description"
    required
    rows="5"
    cols="50"
    maxlength="32000"
    class="usa-textarea"
  ></textarea>
  <!-- END: Description -->

  <!-- START: Description -->
  <div>
    <label class="usa-label" for="information">Additional Info:</label>
    <textarea
      id="information"
      name="00Nt0000000FsTK"
      required
      rows="1"
      cols="50"
      maxlength="80"
      class="usa-textarea"
    ></textarea>
  </div>
  <!-- END: Description -->

  {% if site.contact_form_captcha_enabled %}
  <!-- START: reCAPTCHA -->
  <div
    class="g-recaptcha margin-top-4"
    data-sitekey="6LfeV8YUAAAAAObO6JWt4FUMJUmzbjkufn09mgtl"
    data-callback="clearCaptchaError"
  ></div>
  <input
    type="hidden"
    name="captcha_settings"
    value='{"keyname":"ReCAPTCHA_Login","fallback":"true","orgId":"00DU0000000Leux","ts":""}'
  />
  <div
    id="captcha-error-message"
    class="usa-error-message display-none margin-bottom-4"
    role="alert"
    data-error="{{ site.data.[page.lang].settings.contact_page.support_request_form.errors.captcha_required }}"
  ></div>
  <!-- END: reCAPTCHA -->
  {% endif %}

  <!-- START: Form Actions -->
  <div class="form-actions">
    <button type="submit" class="usa-button usa-button--big usa-button--wide">
      {{ site.data.[page.lang].settings.contact_page.support_request_form.submit }}
    </button>
    <button type="reset" class="usa-button usa-button--big usa-button--wide usa-button--outline">
      {{ site.data.[page.lang].settings.contact_page.support_request_form.reset }}
    </button>
  </div>
  <!-- END: Form Actions -->
</form>
